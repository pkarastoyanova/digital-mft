<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_305439_digital_m.CommProfiles</api_name>
        <client_callable>false</client_callable>
        <description/>
        <name>CommProfiles</name>
        <script><![CDATA[var CommProfiles = Class.create();
CommProfiles.prototype = {
    initialize: function() {
    },
	getLinks: function(client_id, server_id){
		try {
			var r = new sn_ws.RESTMessageV2('x_305439_digital_m.AMFT-Communication links', 'GET communication links');
			new ConnectionSettings().setMandatoryProps(r);
			r.setStringParameterNoEscape('client_id', client_id);
			r.setStringParameterNoEscape('server_id', server_id);

			var response = r.execute();
			var responseBody = response.getBody();
			var httpStatus = response.getStatusCode();
			if(httpStatus != 200){
				gs.error("Failed to get all client communication links; HTTP status: " + httpStatus);
				return;
			} else if(httpStatus == 200){
				var jsonObj = JSON.parse(responseBody);
				return jsonObj.data;
			}

			} catch(ex) {
				var message = ex.message;
			}
	},
	
	sendAsyncSshKeyUpload: function (current, isPesit){
		if(!isPesit){
			var comProfileHelper = new CommProfilesUtils();
			var clientProfile = comProfileHelper.getClientProfileFieldSn(current).profile;
			var attachment_obj = getAttachmentObject(clientProfile.sftp_client.ssh_key, clientProfile.sftp_client.key_alias);
			var r;
			if(gs.nil(attachment_obj)){
				//remote alias, do not try to upload
				// get the key id
				gs.info("attachment object is not found for filename=" + clientProfile.sftp_client.key_alias);
				var restMethod;
				var participant_id = clientProfile.client.cg_product_id;
				if(clientProfile.client.type == "partner"){
					restMethod = "Get partner SSH key";
				} else {
					restMethod = "Get product SSH key";
				}
				
				r = new sn_ws.RESTMessageV2('x_305439_digital_m.AMFT-SSH Keys', restMethod);
				new ConnectionSettings().setMandatoryProps(r);
				
				r.setEccCorrelator("Update SSH Key-" + clientProfile.sys_id);
				r.setStringParameterNoEscape('participant_id', participant_id);
				r.setStringParameterNoEscape('key_name', clientProfile.sftp_client.key_alias);
			} else {
				gs.info("attachment object is found for filename=" + clientProfile.sftp_client.key_alias);
				r = new sn_ws.RESTMessageV2('x_305439_digital_m.AMFT-SSH Keys', "Create SSH Key");
				new ConnectionSettings().setMandatoryProps(r);

				r.setEccCorrelator("Create SSH Key-" + clientProfile.sys_id);
				r.setStringParameterNoEscape('partner_id', clientProfile.client.cg_product_id);
				
				var body = this.getSshKeyRequestBody(attachment_obj);
				r.setRequestBody(body);

			}
			gs.info("Sending async request to create/update the SSH key in CG.");
			r.executeAsync();
		}
	},
	
	uploadCredentials: function(certificate, fileName, passwd, type){
		var certRequest = {};
		certRequest.certificateContent = certificate + "";
		certRequest.name = fileName + "";
		certRequest.isPrivateCertificate = true;
		certRequest.certificatePassword = passwd + "";
		
		var body = JSON.stringify(certRequest);
		gs.info("body: " + body);
		try {
			var method = 'Upload partner certificate';
			if(type == "application"){
				method = 'Upload product certificate';
			}
			 var r = new sn_ws.RESTMessageV2('x_305439_digital_m.AMFT-Certificates', method);
			 new ConnectionSettings().setMandatoryProps(r);
			 r.setRequestBody(body);

			 var response = r.execute();
			 var responseBody = response.getBody();
			 var httpStatus = response.getStatusCode();
			 return (httpStatus == 200);
		}
		catch(ex) {
		 var message = ex.message;
			gs.error(message);
		}
	},
	
	sendAsyncServerProfileCreate: function(server_record, app_name, is_pesit, client_prifle_id){
		sendServerProfileRequest(server_record, app_name, is_pesit, client_prifle_id, undefined, false);
	},
	
	sendAsyncServerProfileUpdate: function(server_record, app_name, is_pesit, client_id, cg_server_profile_id){
		sendServerProfileRequest(server_record, app_name, is_pesit, client_id, cg_server_profile_id, true);
	},
	
	sendAsyncClientDelete: function(client_record){
		gs.debug("sendAsyncClientDelete");
		try { 
		 var r = new sn_ws.RESTMessageV2('x_305439_digital_m.AMFT-Communication links', 'Delete link');
		 new ConnectionSettings().setMandatoryProps(r);
		 r.setStringParameterNoEscape('client_id', client_record.client.cg_product_id);
		 r.setStringParameterNoEscape('client_profile_id', client_record.cg_client_profile_id + "");
		 r.setStringParameterNoEscape('server_id', client_record.server.cg_product_id);
		 r.setEccCorrelator("Delete comm link");

		 var response = r.executeAsync();
		}
		catch(ex) {
		 var message = ex.message;
			gs.error("failed to remove communication link. " + message);
		}
		
	},
	
	sendAsyncServerDelete: function(server_record){
		gs.debug("sendAsyncServerDelete");
		
		try {
		    var r = new sn_ws.RESTMessageV2('x_305439_digital_m.AMFT-Communication links', 'Delete Server');
		    new ConnectionSettings().setMandatoryProps(r);
			r.setStringParameterNoEscape('server_profile_id', server_record.cg_id);
			r.setStringParameterNoEscape('server_product_id', server_record.cg_product_id);
			r.setEccCorrelator("Delete server profile");

			var response = r.executeAsync();
		}
		catch(ex) {
		    var message = ex.message;
			gs.error("failed to remove server communication profile. " + message);
		}
	},
	
	sendAsyncClientProfileCreate: function (client_record, isUpdate){
		gs.debug("sendAsyncClientProfileCreate");
		var restName;
		var body;
		var requireSshKey = requiresSshKey(client_record);
		var sftpClient = isSftpClient(client_record);
		var flowId = getFlowId(client_record);
		
		gs.debug("[sendAsyncClientProfileCreate] requiresSshKey={0}, isSftpClient={1}, flowId={2}", requireSshKey, sftpClient, flowId);
		
		if(sftpClient){
			if(requireSshKey){
				restName = "Create SFTP Key";
				if(isUpdate){
					restName = "Update SFTP Key";
				}
				body = getClientRequestBody(restName, client_record.sftp_client.getRefRecord(), client_record.sys_id, client_record.name);
			} else {
				restName = "Create SFTP Password";
				if(isUpdate){
					restName = "Update SFTP Password";
				}
				body = getClientRequestBody(restName, client_record.sftp_client.getRefRecord(), client_record.sys_id, client_record.name);
			}
		} else {
			restName = "Create PESIT SSL";
			if(isUpdate){
				restName = "Update PESIT SSL";
			}
			body = getClientRequestBody(restName, client_record.pesit_client.getRefRecord(), client_record.sys_id, client_record.name, client_record.client.cg_product_id);
		}
		
		gs.debug("[sendAsyncClientProfileCreate] REST request name={0}", restName);
		
		var clientProductId = client_record.client.cg_product_id;
		var r = new sn_ws.RESTMessageV2('x_305439_digital_m.AMFT-Communication links', restName);
		new ConnectionSettings().setMandatoryProps(r);
		
		if(isUpdate){
			r.setEccCorrelator("Update client profile-" + flowId);
		} else {
			r.setEccCorrelator("Create client profile-" + flowId);
		}
		
		r.setStringParameterNoEscape("clientNodeId", clientProductId);
		r.setStringParameterNoEscape("serverNodeId", client_record.server.cg_product_id); // the server is always ST relay.
		r.setStringParameterNoEscape("serverId", client_record.cg_server_comprofile_id);
		if(isUpdate){
			r.setStringParameterNoEscape("clientid", client_record.cg_client_profile_id);
		}
		
		r.setRequestBody(body);
		gs.debug("Client communication link body=" + body);
		gs.debug("Sending async request to create/update client communication link in CG.");
		r.executeAsync();
	},
	
	getSshKeyRequestBody: function (attachment_obj){
		var requestBody = {};
		requestBody.name = attachment_obj.file_name + "";
		var attachment  = new GlideSysAttachment();
		var content = attachment.getContentBase64(attachment_obj);
		requestBody.keyContent = content;

		return JSON.stringify(requestBody);
	},
	
	getInfo: function(productId){
		var body = getProtocolInfo(productId);
		gs.info("protocol info body=" +body);
	},
	
    type: 'CommProfiles'
};

function sendServerProfileRequest(server_record, app_name, is_pesit, client_prifle_id, cg_server_prof_id, isServerUpdate){

	var request_name = getServerRequestName(is_pesit, isServerUpdate);

	var relayHelper = new GetStRelay();
	var relayId = relayHelper.getStRelayId();

	var r = new sn_ws.RESTMessageV2('x_305439_digital_m.AMFT-Communication Servers', request_name);
	new ConnectionSettings().setMandatoryProps(r);
	r.setStringParameterNoEscape('server_id', relayId);
	if(isServerUpdate){
		r.setStringParameterNoEscape("profile_id", cg_server_prof_id);
	}
	var correlator = request_name + "-" + client_prifle_id;
	gs.info("correlator: " + correlator);
	r.setEccCorrelator(correlator);

	var serverRequest = getRequestBody(server_record, app_name, is_pesit);
	var body = JSON.stringify(serverRequest);
	gs.debug("Server profile update request body: " + body);
	r.setRequestBody(body);
	gs.info("Sending async request to {0} profile in CG.", request_name);
	r.executeAsync();
}

function getServerRequestName(is_pesit, is_update){
	var sufix;
	var prefix;
	
	if(is_update === true){
		prefix = "Update ";
	} else {
		prefix = "Create ";
	}
	
	if(is_pesit === true){
		sufix = 'PESIT Server';
	} else {
		sufix = 'SFTP Server';
	}
	
	return prefix + sufix;
}

function getAttachmentObject(sftp_client_sys_id, file_name){
	var g_record = new GlideRecord("sys_attachment");
		g_record.addQuery("sys_id", sftp_client_sys_id);
	    g_record.addQuery("file_name", file_name);
		g_record.orderByDesc("sys_created_on");
		g_record.query();
	if(g_record.next()){
		return g_record;
	}
}

function getClientRequestBody(type, settings, sys_id, name, product_id){
	var body = {};
	switch(type){
		case "Update SFTP Key":
		case "Create SFTP Key":
			body.name = name + "";
			body.keyAlias = settings.key_alias + "";
			body.login = settings.login_name + "";
			break;
		case "Update SFTP Password":
		case "Create SFTP Password":
			body.name = name + "";
			body.password = settings.password.getDecryptedValue();
			body.login = settings.login_name + "";
			break;
		case "Update PESIT SSL":
		case "Create PESIT SSL":
			body.name = name + "";
			body.certificateAlias = settings.certificate_alias + "";
			body.pesitLogin = settings.login_name.toUpperCase();
			body.cft_properties = getProtocolInfo(product_id); // Aditional API Call
			break;
	}
	return JSON.stringify(body);
}

function getProtocolInfo(product_id){
	gs.debug("getProtocolInfo productid=" + product_id);
	try { 
		var r = new sn_ws.RESTMessageV2('x_305439_digital_m.AMFT-Communication links', 'Get protocol info');
		new ConnectionSettings().setMandatoryProps(r);
		r.setStringParameterNoEscape('product_id', product_id);
		r.setStringParameterNoEscape('protocol_name', gs.getProperty("x_305439_digital_m.cft.protocol.name"));
		
		var response = r.executeAsync();
		response.waitForResponse(70);
		var responseBody = response.getBody();
		var httpStatus = response.getStatusCode();
		gs.debug("Protocol info=" + responseBody + " status= " + httpStatus);
		if(httpStatus == "200"){
			var body = JSON.parse(responseBody);
			return body.data.AMFTCFTProtocol;
		}
	}
	catch(ex) {
		var message = ex.message;
		gs.error("Protocol info error. " + message);
	}
}

function getRequestBody(server_record, app_name, isPesit){
	var stRelayUtils = new GetStRelay();
	var serverRequest = {};
	
	serverRequest.networkZone = stRelayUtils.getStZone();
	serverRequest.hosts = [server_record.host + ""];
	serverRequest.port = server_record.port + "";
	
	if(isPesit){
		serverRequest.name = stRelayUtils.pesit_profile_name + "_" + server_record.sys_id;
		serverRequest.certificateAlias = server_record.certificate_alias + "";
		serverRequest.clientAuthenticationRequired = "Yes";
		serverRequest.networkProtocol = "TCP";
		serverRequest.pesitLogin = app_name + "";
	} else {
		serverRequest.name = stRelayUtils.sftp_profile_name + "_" + server_record.sys_id;
		serverRequest.keyAlias = server_record.login_key_alias + "";
	}
	return serverRequest;
}

function isSftpClient(clientRecord){
	return !gs.nil(clientRecord.sftp_client);
}

function requiresSshKey(clientRecord){
	return !gs.nil(clientRecord.sftp_client) && clientRecord.sftp_client.login_type == "PUBLIC_KEY";
}

function getFlowId(clientRecord){
	var flowRecord = new GlideRecord("x_305439_digital_m_flow_settings");
	var query = flowRecord.addQuery("client_profile_1", clientRecord.sys_id);
	query.addOrCondition("client_profile_2", clientRecord.sys_id);
	flowRecord.query();
	if(flowRecord.next()){
		return flowRecord.sys_id;
	} else {
		gs.error("Cannot find the flow settings to which this client profile belongs to.");
	}
}
]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2019-03-28 17:13:48</sys_created_on>
        <sys_id>37aad2984f6433002f86b5e18110c791</sys_id>
        <sys_mod_count>94</sys_mod_count>
        <sys_name>CommProfiles</sys_name>
        <sys_package display_value="digital-mft" source="x_305439_digital_m">3006e9b44f2323002f86b5e18110c7cd</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="digital-mft">3006e9b44f2323002f86b5e18110c7cd</sys_scope>
        <sys_update_name>sys_script_include_37aad2984f6433002f86b5e18110c791</sys_update_name>
        <sys_updated_by>receiver</sys_updated_by>
        <sys_updated_on>2019-06-13 07:40:31</sys_updated_on>
    </sys_script_include>
</record_update>
